---
description: 
globs: 
alwaysApply: false
---
# Domain-Driven Design Architecture

**Project**: dhafnck_mcp_main - fastmcp Task Management Integration  
**Package**: fastmcp.dhafnck_mcp - DDD-based task management system  
**Last Updated**: 2025-01-18  

## ðŸ—ï¸ DDD Architecture Overview

The **fastmcp** task management system follows Domain-Driven Design principles with clean layer separation for maintainability, testability, and extensibility. The implementation is fully integrated into the fastmcp framework as `fastmcp.dhafnck_mcp` with comprehensive MCP tool exposure through a consolidated architecture.

**Key Architecture Principles:**
- **Clean Layer Separation**: Domain â†’ Application â†’ Infrastructure â†’ Interface
- **Dependency Inversion**: All dependencies point inward toward the domain
- **MCP Integration**: Task management exposed as MCP tools for AI assistant integration
- **Type Safety**: Full type annotations throughout the codebase
- **Async/Await**: Asynchronous implementation for performance

## ðŸ“ Layer Structure

### Domain Layer (`src/fastmcp/dhafnck_mcp/domain/`)
**Core business logic and rules - No external dependencies**

```
domain/
â”œâ”€â”€ ðŸ“ entities/                   # Core business entities
â”‚   â”œâ”€â”€ ðŸ“„ task.py                 # Task entity with business rules (933 lines)
â”‚   â”œâ”€â”€ ðŸ“„ agent.py                # Agent entity for multi-agent coordination (277 lines)
â”‚   â”œâ”€â”€ ðŸ“„ project.py              # Project entity for project management (254 lines)
â”‚   â”œâ”€â”€ ðŸ“„ task_tree.py            # Task tree entity for workstream organization (212 lines)
â”‚   â””â”€â”€ ðŸ“„ work_session.py         # Work session entity for tracking (242 lines)
â”œâ”€â”€ ðŸ“ value_objects/              # Immutable domain value objects
â”‚   â”œâ”€â”€ ðŸ“„ task_id.py              # Task identifier value object
â”‚   â”œâ”€â”€ ðŸ“„ task_status.py          # Status enumeration and logic
â”‚   â””â”€â”€ ðŸ“„ priority.py             # Priority value object with business rules
â”œâ”€â”€ ðŸ“ enums/                      # Domain enumerations
â”‚   â”œâ”€â”€ ðŸ“„ task_status.py          # Task status enumeration
â”‚   â”œâ”€â”€ ðŸ“„ priority.py             # Priority levels
â”‚   â””â”€â”€ ðŸ“„ agent_role.py           # Agent role definitions
â”œâ”€â”€ ðŸ“ events/                     # Domain events for event-driven architecture
â”‚   â”œâ”€â”€ ðŸ“„ task_events.py          # Task lifecycle events
â”‚   â””â”€â”€ ðŸ“„ project_events.py       # Project-related events
â”œâ”€â”€ ðŸ“ exceptions/                 # Domain-specific exceptions
â”‚   â”œâ”€â”€ ðŸ“„ task_exceptions.py      # Task-related business rule violations
â”‚   â””â”€â”€ ðŸ“„ validation_exceptions.py # Domain validation errors
â”œâ”€â”€ ðŸ“ repositories/               # Repository interfaces (abstractions)
â”‚   â”œâ”€â”€ ðŸ“„ task_repository.py      # Task persistence interface
â”‚   â”œâ”€â”€ ðŸ“„ project_repository.py   # Project persistence interface
â”‚   â””â”€â”€ ðŸ“„ agent_repository.py     # Agent persistence interface
â””â”€â”€ ðŸ“ services/                   # Domain services for complex business logic
    â”œâ”€â”€ ðŸ“„ task_orchestration.py   # Task orchestration business rules
    â””â”€â”€ ðŸ“„ dependency_resolver.py  # Dependency resolution logic
```

**Key Domain Entities:**
- **Task**: Central business entity with comprehensive business rules and validation
- **Agent**: Multi-agent coordination entity with role-based capabilities
- **Project**: Project management entity with task tree organization
- **TaskTree**: Workstream organization for parallel development
- **WorkSession**: Session tracking for productivity and analytics

### Application Layer (`src/fastmcp/dhafnck_mcp/application/`)
**Use cases and application services - Orchestrates domain logic**

```
application/
â”œâ”€â”€ ðŸ“ use_cases/                  # Business use cases (application operations)
â”‚   â”œâ”€â”€ ðŸ“„ create_task.py          # Create task use case (110 lines)
â”‚   â”œâ”€â”€ ðŸ“„ get_task.py             # Retrieve task use case (49 lines)
â”‚   â”œâ”€â”€ ðŸ“„ update_task.py          # Update task use case (91 lines)
â”‚   â”œâ”€â”€ ðŸ“„ delete_task.py          # Delete task use case (41 lines)
â”‚   â”œâ”€â”€ ðŸ“„ complete_task.py        # Complete task use case (59 lines)
â”‚   â”œâ”€â”€ ðŸ“„ list_tasks.py           # List/filter tasks use case (39 lines)
â”‚   â”œâ”€â”€ ðŸ“„ search_tasks.py         # Search tasks use case (19 lines)
â”‚   â”œâ”€â”€ ðŸ“„ manage_subtasks.py      # Subtask management use case (157 lines)
â”‚   â”œâ”€â”€ ðŸ“„ manage_dependencies.py  # Dependency management use case (178 lines)
â”‚   â”œâ”€â”€ ðŸ“„ do_next.py              # Intelligent next task recommendation (309 lines)
â”‚   â””â”€â”€ ðŸ“„ call_agent.py           # Agent integration use case (99 lines)
â”œâ”€â”€ ðŸ“ services/                   # Application services
â”‚   â”œâ”€â”€ ðŸ“„ task_application_service.py # Main application service coordinator
â”‚   â”œâ”€â”€ ðŸ“„ project_service.py      # Project management service
â”‚   â””â”€â”€ ðŸ“„ agent_coordination_service.py # Agent coordination service
â””â”€â”€ ðŸ“ dtos/                       # Data Transfer Objects
    â”œâ”€â”€ ðŸ“„ task_dto.py              # Task data transfer objects
    â”œâ”€â”€ ðŸ“„ create_task_request.py   # Task creation request DTO
    â””â”€â”€ ðŸ“„ update_task_request.py   # Task update request DTO
```

**Key Use Cases:**
- **create_task**: Comprehensive task creation with validation and business rules
- **do_next**: Intelligent task recommendation based on priorities and dependencies
- **manage_subtasks**: Hierarchical task breakdown and management
- **manage_dependencies**: Task relationship and dependency management
- **call_agent**: Agent integration and role-based task assignment

### Infrastructure Layer (`src/fastmcp/dhafnck_mcp/infrastructure/`)
**External concerns and persistence - Implements domain interfaces**

```
infrastructure/
â”œâ”€â”€ ðŸ“ repositories/               # Repository implementations
â”‚   â”œâ”€â”€ ðŸ“„ json_task_repository.py # JSON-based task persistence with atomic operations
â”‚   â”œâ”€â”€ ðŸ“„ json_project_repository.py # JSON-based project persistence
â”‚   â””â”€â”€ ðŸ“„ json_agent_repository.py # JSON-based agent persistence
â””â”€â”€ ðŸ“ services/                   # External service integrations
    â”œâ”€â”€ ðŸ“„ file_auto_rule_generator.py # File-based auto rule generation
    â”œâ”€â”€ ðŸ“„ yaml_agent_loader.py    # YAML-based agent configuration loading
    â””â”€â”€ ðŸ“„ cursor_integration_service.py # Cursor IDE integration service
```

**Key Infrastructure Components:**
- **JSON Repositories**: Atomic file-based persistence with transaction safety
- **Auto Rule Generator**: Dynamic AI context rule generation for Cursor integration
- **Agent Loader**: YAML-based agent configuration and capability loading
- **Cursor Integration**: Deep integration with Cursor IDE and rules system

### Interface Layer (`src/fastmcp/dhafnck_mcp/interface/`)
**MCP integration and external interfaces - Exposes functionality via MCP protocol**

```
interface/
â”œâ”€â”€ ðŸ“„ consolidated_mcp_tools_v2.py    # Main MCP tools implementation (1188 lines)
â”œâ”€â”€ ðŸ“„ cursor_rules_tools.py           # Cursor-specific MCP tools (617 lines)
â”œâ”€â”€ ðŸ“„ consolidated_mcp_server.py      # MCP server configuration (51 lines)
â”œâ”€â”€ ðŸ“„ ddd_mcp_server.py               # DDD-specific server setup (45 lines)
â””â”€â”€ ðŸ“„ mcp_tools.py                    # Base MCP tool definitions (12 lines)
```

**MCP Tool Architecture:**
- **consolidated_mcp_tools_v2.py**: Core task management tools with comprehensive functionality
- **cursor_rules_tools.py**: Specialized tools for Cursor IDE integration and rule management
- **Server Configuration**: Proper MCP server setup with DDD integration

## ðŸ› ï¸ Current MCP Tool Architecture

### Core Task Management Tools (consolidated_mcp_tools_v2.py)
- **`manage_project`**: Multi-agent project lifecycle management with orchestration
- **`manage_task`**: Comprehensive task management with 15+ actions (create, get, update, delete, complete, list, search, next)
- **`manage_subtask`**: Hierarchical subtask management with progress tracking
- **`manage_agent`**: Agent coordination, assignment, and workload balancing
- **`call_agent`**: Agent capability loading and role-based integration

### Cursor Integration Tools (cursor_rules_tools.py)
- **`update_auto_rule`**: Direct AI context rule updates for dynamic behavior
- **`validate_rules`**: Rule file quality analysis and validation
- **`manage_cursor_rules`**: Complete rule file system management
- **`regenerate_auto_rule`**: Smart context generation based on tasks and roles
- **`validate_tasks_json`**: Task database integrity validation and health checks

## ðŸŽ¯ DDD Benefits in fastmcp Integration

### Clean Separation of Concerns
- **Domain Logic**: Pure business logic isolated from MCP protocol details
- **Business Rules**: Centralized in domain entities with comprehensive validation
- **Infrastructure**: JSON-based persistence easily replaceable with databases
- **MCP Integration**: Clean interface layer that doesn't pollute business logic

### Type Safety and Modern Python
- **Full Type Annotations**: Complete type safety throughout all layers
- **Async/Await**: Asynchronous implementation for high-performance MCP operations
- **Pydantic Integration**: Type-safe data validation and serialization
- **Modern Python**: Python 3.10+ features with comprehensive error handling

### Testability and Quality
- **Unit Tests**: Domain logic tested in complete isolation
- **Integration Tests**: Application layer coordination with comprehensive coverage
- **MCP Integration Tests**: End-to-end testing of MCP tool functionality
- **Type Checking**: Pyright validation ensures compile-time safety

### Extensibility and Maintainability
- **New Use Cases**: Easy addition without modifying existing code
- **Multiple Protocols**: MCP integration doesn't prevent other protocol support
- **Storage Flexibility**: Repository pattern allows multiple persistence backends
- **Agent Integration**: Pluggable agent system with YAML-based configuration

## ðŸ§ª Testing Architecture

### Test Coverage Strategy
```
tests/
â”œâ”€â”€ ðŸ“„ test_task_management_integration.py      # Main integration tests (527 lines)
â”œâ”€â”€ ðŸ“„ test_task_management_integration_working.py # Working integration tests (592 lines)
â”œâ”€â”€ ðŸ“„ test_simple_integration.py               # Simple integration tests (143 lines)
â”œâ”€â”€ ðŸ“ dhafnck_mcp/                         # Task management specific tests
â”‚   â”œâ”€â”€ ðŸ“„ test_domain_entities.py              # Domain entity unit tests
â”‚   â”œâ”€â”€ ðŸ“„ test_use_cases.py                    # Use case integration tests
â”‚   â”œâ”€â”€ ðŸ“„ test_mcp_integration.py              # MCP tool functionality tests
â”‚   â””â”€â”€ ðŸ“„ test_repository_implementations.py   # Infrastructure layer tests
â”œâ”€â”€ ðŸ“ unit/                                    # Isolated unit tests
â””â”€â”€ ðŸ“ integration/                             # Cross-layer integration tests
```

### Test Organization Principles
- **Domain Tests**: Pure unit tests with no external dependencies
- **Application Tests**: Use case testing with mocked infrastructure
- **Infrastructure Tests**: Repository and external service integration testing
- **MCP Integration Tests**: End-to-end workflow validation through MCP protocol

## ðŸ”§ Technology Stack

### Core Framework Integration
- **fastmcp**: Modern MCP server framework with full integration
- **Python 3.10+**: Modern Python with type annotations and async/await
- **JSON Storage**: Atomic file operations with transaction safety
- **Pydantic**: Type-safe data validation and serialization
- **Rich Logging**: Comprehensive logging with structured output

### Development and Quality Tools
- **pytest**: Comprehensive testing framework with asyncio support
- **pyright**: Static type checking with strict mode
- **ruff**: Modern Python linting and formatting
- **uv**: Modern Python package management and dependency resolution
- **pre-commit**: Automated code quality checks

### Dependencies and Integration
- **MCP Protocol**: Full Model Context Protocol compliance
- **YAML Processing**: Agent configuration and rule management
- **JSON Processing**: Task persistence and data interchange
- **File System**: Atomic operations and safe concurrent access
- **Async/Await**: High-performance asynchronous operations

## ðŸ”„ Architecture Evolution

### Current State (2025-01-18)
- **âœ… Full DDD Implementation**: Complete domain-driven design with all layers
- **âœ… fastmcp Integration**: Native integration with fastmcp framework
- **âœ… MCP Tool Suite**: Comprehensive MCP tools for all task management operations
- **âœ… Multi-Agent Support**: Full project, agent, and task tree coordination
- **âœ… Cursor Integration**: Deep integration with Cursor IDE and rules system
- **âœ… Type Safety**: Complete type annotations with Pyright validation
- **âœ… Async Implementation**: High-performance asynchronous operations
- **âœ… Comprehensive Testing**: Full test coverage across all layers

### Key Architectural Decisions
- **JSON-Based Persistence**: Simple, reliable, and easily debuggable storage
- **Atomic Operations**: Transaction safety for concurrent access
- **Event-Driven Architecture**: Domain events for loose coupling and extensibility
- **Repository Pattern**: Clean abstraction for data persistence
- **Use Case Architecture**: Clear business operation boundaries
- **MCP-First Design**: Optimized for AI assistant integration

### Future Enhancement Opportunities
- **Database Integration**: Optional database backends for large-scale deployments
- **Event Streaming**: External event bus integration for distributed systems
- **Advanced Analytics**: Task performance and productivity analytics
- **Workflow Automation**: Advanced orchestration and automation capabilities
- **Multi-Tenant Support**: Project isolation and access control

## ðŸ“‹ Development Guidelines

### Layer Communication Rules
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Interface     â”‚ â† MCP Tools, Server Configuration
â”‚   (MCP Layer)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Infrastructure  â”‚ â† Repositories, External Services
â”‚    Layer        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Application    â”‚ â† Use Cases, Application Services
â”‚     Layer       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Domain       â”‚ â† Entities, Value Objects, Business Rules
â”‚     Layer       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Dependency Rules:**
- **Domain Layer**: No dependencies on other layers (pure business logic)
- **Application Layer**: Can depend only on Domain layer
- **Infrastructure Layer**: Can depend on Domain and Application layers
- **Interface Layer**: Can access all layers but should minimize direct domain access

### Code Organization Principles
- **Single Responsibility**: Each class and module has one clear purpose
- **Dependency Inversion**: Depend on abstractions, not concrete implementations
- **Open/Closed Principle**: Open for extension, closed for modification
- **Interface Segregation**: Small, focused interfaces and contracts
- **Don't Repeat Yourself**: Shared functionality properly abstracted

### Adding New Features (Step-by-Step)
1. **Domain First**: Define new entities, value objects, or business rules in domain layer
2. **Use Cases**: Create application layer use cases for new operations
3. **Infrastructure**: Implement necessary persistence or external service integrations
4. **MCP Tools**: Add MCP tool interfaces for AI assistant integration
5. **Testing**: Write comprehensive tests at all layers
6. **Documentation**: Update architectural documentation and usage examples

## ðŸŽª Usage Examples

### Basic Task Management via MCP
```python
# MCP tool call for task creation
{
    "action": "create",
    "title": "Implement user authentication",
    "description": "Add OAuth2 authentication to the API",
    "priority": "high",
    "assignee": "@coding_agent",
    "estimated_effort": "medium"
}
```

### Multi-Agent Project Coordination
```python
# Project setup with agent coordination
{
    "action": "create",
    "project_id": "auth_system",
    "name": "Authentication System",
    "description": "Complete OAuth2 implementation"
}

# Agent assignment to task trees
{
    "action": "assign",
    "project_id": "auth_system",
    "agent_id": "security_expert",
    "tree_id": "security_review"
}
```

### Intelligent Task Orchestration
```python
# Get next recommended task
{
    "action": "next"
}
# Returns optimized task recommendation based on:
# - Priority levels and urgency
# - Dependency resolution
# - Agent availability and capabilities
# - Workload balancing
```

## ðŸ”’ Security and Data Integrity

### Data Protection
- **Atomic Operations**: All file operations are atomic to prevent corruption
- **Input Validation**: Comprehensive validation at domain and application layers
- **Type Safety**: Compile-time safety through complete type annotations
- **Error Handling**: Graceful error handling with detailed logging

### Access Control
- **Agent-Based Access**: Role-based access through agent assignments
- **Project Isolation**: Tasks organized by projects with clear boundaries
- **Audit Trail**: Comprehensive logging of all operations and changes

---

## ðŸ›ï¸ Architecture Summary

The **fastmcp.dhafnck_mcp** system demonstrates a mature Domain-Driven Design implementation fully integrated with the fastmcp framework. It provides:

- **Clean Architecture**: Proper layer separation with inward-only dependencies
- **MCP Integration**: Native AI assistant integration through comprehensive MCP tools
- **Type Safety**: Complete type annotations with Pyright validation
- **High Performance**: Async/await implementation for optimal performance
- **Extensibility**: Plugin architecture for agents, storage backends, and protocols
- **Reliability**: Atomic operations and comprehensive error handling
- **Developer Experience**: Rich tooling, comprehensive testing, and clear documentation

This architecture ensures long-term maintainability while providing powerful task management capabilities optimized for AI assistant integration through the Model Context Protocol.

---
> **Architecture Principle**: Maintain clean layer separation with inward-only dependencies while providing comprehensive MCP integration for optimal AI assistant collaboration and task management automation.